import type {
  NextPage,
  GetServerSideProps,
  GetServerSidePropsContext,
} from "next";
import Head from "next/head";
import { gql } from "@apollo/client";

import { createApolloClient } from "./_app";
import Sidebar from "../components/Sidebar";
import Conversations from "../components/Conversations";

const Home: NextPage = () => {
  return (
    <div>
      <Head>
        <title>Whatsapp Clone</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <Sidebar />
      <Conversations />
    </div>
  );
};

export const getServerSideProps: GetServerSideProps = async ({
  req,
  res,
}: GetServerSidePropsContext) => {
  const cookies = req.cookies;

  const cookieName = Object.keys(cookies);

  let cookie = "";

  cookieName.forEach((c) => {
    const newCookie = ` ${c}=${cookies[c]};`;
    cookie = cookie + newCookie;
  });

  const CURRENT_USER_QUERY = gql`
    query GetCurrentUser {
      currentUser {
        id
        email
        username
        updatedAt
        createdAt
      }
    }
  `;

  const result = await createApolloClient({ cookie }).query({
    query: CURRENT_USER_QUERY,
  });

  if (!result.data.currentUser) {
    res.writeHead(301, { Location: "/login" });
    res.end();
  }

  return {
    props: {},
  };
};

export default Home;
